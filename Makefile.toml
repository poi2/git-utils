[config]
default_to_workspace = false

[tasks.test]
description = "Run all tests"
command = "cargo"
args = ["test", "--all-features"]

[tasks.fmt]
description = "Check code formatting"
command = "cargo"
args = ["fmt", "--all", "--", "--check"]

[tasks.fmt-fix]
description = "Fix code formatting"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy]
description = "Run clippy linter"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.check-unused-dependencies]
description = "Check for unused dependencies with cargo-udeps"
toolchain = "nightly"
command = "cargo"
args = ["udeps", "--all-targets"]

[tasks.check-all]
description = "Run all checks (format, clippy, test, unused dependencies)"
dependencies = ["fmt", "clippy", "test", "check-unused-dependencies"]

[tasks.ci]
description = "Run CI checks (same as check-all)"
alias = "check-all"

[tasks.install-hooks]
description = "Install git hooks"
script = '''
#!/bin/bash
set -e

HOOKS_DIR="$(git rev-parse --git-path hooks)"
mkdir -p "$HOOKS_DIR"

# Create pre-commit hook
cat > "$HOOKS_DIR/pre-commit" << 'EOF'
#!/bin/bash
# Pre-commit hook for git-utils
# Runs cargo make check-all before allowing commit

echo "Running pre-commit checks..."
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"
cargo make check-all

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed!"
    echo "Please fix the errors above before committing."
    echo ""
    echo "To bypass this hook (not recommended), use:"
    echo "  git commit --no-verify"
    exit 1
fi

echo "‚úÖ Pre-commit checks passed!"
EOF

chmod +x "$HOOKS_DIR/pre-commit"
echo "‚úÖ Installed pre-commit hook"

# Create pre-push hook
cat > "$HOOKS_DIR/pre-push" << 'EOF'
#!/bin/bash
# Pre-push hook for git-utils
# Runs cargo make check-all before allowing push

echo "Running pre-push checks..."
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"
cargo make check-all

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Pre-push checks failed!"
    echo "Please fix the errors above before pushing."
    echo ""
    echo "To bypass this hook (not recommended), use:"
    echo "  git push --no-verify"
    exit 1
fi

echo "‚úÖ Pre-push checks passed!"
EOF

chmod +x "$HOOKS_DIR/pre-push"
echo "‚úÖ Installed pre-push hook"

# Install commit-msg hook for commitlint
REPO_ROOT="$(git rev-parse --show-toplevel)"
if [ -f "$REPO_ROOT/hooks/commit-msg" ]; then
    cp "$REPO_ROOT/hooks/commit-msg" "$HOOKS_DIR/commit-msg"
    chmod +x "$HOOKS_DIR/commit-msg"
    echo "‚úÖ Installed commit-msg hook (commitlint)"
else
    echo "‚ö†Ô∏è  hooks/commit-msg not found, skipping commit-msg hook installation"
fi

echo ""
echo "Git hooks installed successfully!"
echo ""
echo "Hooks will run automatically on commit and push."
echo "To bypass hooks: git commit/push --no-verify"
'''

[tasks.uninstall-hooks]
description = "Uninstall git hooks"
script = '''
#!/bin/bash
HOOKS_DIR="$(git rev-parse --git-path hooks)"

if [ -d "$HOOKS_DIR" ]; then
    rm -f "$HOOKS_DIR/pre-commit"
    rm -f "$HOOKS_DIR/pre-push"
    rm -f "$HOOKS_DIR/commit-msg"
    echo "‚úÖ Git hooks uninstalled"
else
    echo "‚ö†Ô∏è  Hooks directory not found"
fi
'''

[tasks.install-all]
description = "Install all binaries to local cargo bin"
script = '''
#!/bin/bash
set -e

echo "Installing all git-utils binaries..."
echo ""

# NOTE: Keep this list in sync with uninstall-all task
BINARIES=(
    "git-branch-switch"
    "git-branch-delete"
    "git-repos"
    "git-pr-merged"
    "git-utils"
)

for binary in "${BINARIES[@]}"; do
    echo "üì¶ Installing $binary..."
    cargo install --path "crates/$binary" --force --locked
    echo ""
done

echo "‚úÖ All binaries installed successfully!"
echo ""
echo "Installed binaries:"
for binary in "${BINARIES[@]}"; do
    echo "  - $binary"
done
echo ""
echo "Binaries are available in: ${CARGO_HOME:-$HOME/.cargo}/bin"
'''

[tasks.uninstall-all]
description = "Uninstall all binaries from local cargo bin"
script = '''
#!/bin/bash

echo "Uninstalling all git-utils binaries..."
echo ""

# NOTE: Keep this list in sync with install-all task
BINARIES=(
    "git-branch-switch"
    "git-branch-delete"
    "git-repos"
    "git-pr-merged"
    "git-utils"
)

for binary in "${BINARIES[@]}"; do
    echo "üóëÔ∏è  Uninstalling $binary..."
    if cargo uninstall "$binary" 2>&1 | grep -q "package .* is not installed"; then
        echo "  ‚ö†Ô∏è  $binary not found (may not be installed)"
    elif [ ${PIPESTATUS[0]} -ne 0 ]; then
        echo "  ‚ùå Failed to uninstall $binary"
        exit 1
    fi
done

echo ""
echo "‚úÖ Uninstall process completed!"
'''
